@using MudBlazor
@using System.Globalization

<div class="calendar-modal @(IsVisible ? "show" : "")" @onclick="Close">
    <div class="calendar-modal-content" @onclick:stopPropagation="true">
        <div class="timezone-info">
            Timezone: <strong>@CurrentTimeZoneDisplay</strong>
        </div>

        <MudCalendar T="CalendarItem"
                     @ref="calendar"
                     Items="@calendarItems"
                     View="@CurrentView"
                     Date="@InitialDate"
                     SlotDuration="00:45:00"
                     StartHour="10"
                     EndHour="21"
                     ItemClicked="OnSlotClicked"
                     Class="mud-calendar-event" />
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public List<DateTime> Slots { get; set; } = new();
    [Parameter] public List<(DateTimeOffset Start, DateTimeOffset End)> BusyTimes { get; set; } = new();
    [Parameter] public DateTime? FirstAvailableDate { get; set; }
    [Parameter] public EventCallback<string> OnSlotSelected { get; set; }
    [Parameter] public string CurrentTimeZoneDisplay { get; set; } = "detecting...";
    [Parameter] public EventCallback<CalendarItem> OnEventClick { get; set; }

    private MudCalendar calendar;
    private List<CalendarItem> calendarItems = new();
    private DateTime InitialDate => FirstAvailableDate ?? DateTime.Now;
    private CalendarView CurrentView => WindowWidth <= 1024 ? CalendarView.Day : CalendarView.Week;
    private int WindowWidth { get; set; } = 1920;
    private string lastClickedEvent = "None";

    protected override void OnParametersSet()
    {
        calendarItems.Clear();

        foreach (var busy in BusyTimes)
        {
            calendarItems.Add(new CalendarItem
            {
                Start = busy.Start.LocalDateTime,
                End = busy.End.LocalDateTime,
                Text = "â›” Busy"
            });
        }

        foreach (var slot in Slots)
        {
            calendarItems.Add(new CalendarItem
            {
                Start = slot,
                End = slot.AddMinutes(45),
                Text = "ðŸŸ¢ Available"
            });
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            WindowWidth = await JSRuntime.InvokeAsync<int>("eval", "window.innerWidth");
            StateHasChanged();
        }
    }

    private async Task OnSlotClicked(CalendarItem item)
    {
        if (item.Text.Contains("Available"))
        {
            await OnSlotSelected.InvokeAsync(item.Start.ToString("o"));
        }

        await OnEventClick.InvokeAsync(item);
    }

    private async void Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(IsVisible);
    }
}
