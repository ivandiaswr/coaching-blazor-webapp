@using BusinessLayer.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor

<MudDialog Class="email-dialog" 
           Options="new DialogOptions { BackdropClick = false, MaxWidth = MaxWidth.ExtraExtraLarge }">
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-3" />
            <MudText Typo="Typo.h6">Send Email to Subscribers</MudText>
        </div>
    </TitleContent>

    <DialogContent>
        <div class="email-editor-container">
            <div class="email-compose-panel">
                <MudForm @ref="EmailForm" Model="@this">
                    <div class="template-section">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Class="mr-2" />
                            Quick Email Templates (Optional)
                        </MudText>
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                            Click any template below to automatically fill your email with professional content. You can also write your own message from scratch!
                        </MudAlert>
                        <MudExpansionPanels>
                            <MudExpansionPanel Text="üìß Choose Email Template (Optional)">
                                <ChildContent>
                                    <div class="template-buttons">
                                        <MudButton OnClick="@(() => ApplyTemplate("welcome"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2 mr-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.EmojiEmotions" Class="mr-2" />
                                                <div>
                                                    <div><strong>Welcome Email</strong></div>
                                                    <small>New subscriber greeting</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                        <MudButton OnClick="@(() => ApplyTemplate("newsletter"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2 mr-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.Newspaper" Class="mr-2" />
                                                <div>
                                                    <div><strong>Newsletter</strong></div>
                                                    <small>Monthly updates & news</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                        <MudButton OnClick="@(() => ApplyTemplate("announcement"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2 mr-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.Campaign" Class="mr-2" />
                                                <div>
                                                    <div><strong>Announcement</strong></div>
                                                    <small>Important updates</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                        <MudButton OnClick="@(() => ApplyTemplate("coaching"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2 mr-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.Psychology" Class="mr-2" />
                                                <div>
                                                    <div><strong>Coaching Tips</strong></div>
                                                    <small>Personal growth insights</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                        <MudButton OnClick="@(() => ApplyTemplate("event"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2 mr-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.Event" Class="mr-2" />
                                                <div>
                                                    <div><strong>Event Invitation</strong></div>
                                                    <small>Workshops & sessions</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                        <MudButton OnClick="@(() => ApplyTemplate("gratitude"))"
                                                 Variant="Variant.Outlined" Size="Size.Small"
                                                 Class="template-btn mb-2">
                                            <div class="template-content">
                                                <MudIcon Icon="@Icons.Material.Filled.Favorite" Class="mr-2" />
                                                <div>
                                                    <div><strong>Thank You</strong></div>
                                                    <small>Appreciation message</small>
                                                </div>
                                            </div>
                                        </MudButton>
                                    </div>
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </div>

                    <div class="compose-form">
                        <MudTextField @bind-Value="Subject"
                                      Label="Email Subject"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      @onkeyup="ValidateForm"
                                      @onchange="ValidateForm"
                                      @oninput="ValidateForm"
                                      Class="subject-field"
                                      HelperText="A compelling subject line increases open rates"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@(string.IsNullOrWhiteSpace(Subject) ? Icons.Material.Filled.Warning : Icons.Material.Filled.CheckCircle)"
                                      AdornmentColor="@(string.IsNullOrWhiteSpace(Subject) ? Color.Warning : Color.Success)" />

                        <MudTextField @bind-Value="EmailContent"
                                      Label="Email Message"
                                      Variant="Variant.Outlined"
                                      Lines="12"
                                      Required="true"
                                      @onkeyup="ValidateForm"
                                      @onchange="ValidateForm"
                                      @oninput="ValidateForm"
                                      Class="content-field"
                                      HelperText="@($"Characters: {EmailContent.Length} | Keep it personal and engaging")"
                                      Placeholder="Write your message here. Remember to be warm and authentic - your subscribers want to hear from you personally!" />

                        <div class="attachment-section">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.AttachFile" Class="mr-2" />
                                Attachment (Optional)
                            </MudText>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                <strong>Supported files:</strong> PDF, Word documents, images (JPG, PNG)<br/>
                                <strong>Maximum size:</strong> 10MB per file | <strong>Maximum files:</strong> 3
                            </MudAlert>
                            <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"
                                           MaximumFileCount="3" 
                                           FilesChanged="OnFilesChanged" 
                                           MaximumFileSize="10485760">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.CloudUpload"
                                               Class="upload-button">
                                        <MudText>Click to Upload Attachments (Max 3 files)</MudText>
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            @if (SelectedFiles.Any())
                            {
                                <div class="attachment-info mt-3">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Class="mr-2" />
                                        Attached Files (@SelectedFiles.Count/3)
                                    </MudText>
                                    @foreach (var file in SelectedFiles)
                                    {
                                        <MudPaper Class="pa-3 mb-2" Elevation="2">
                                            <div class="d-flex align-center justify-space-between">
                                                <div class="d-flex align-center">
                                                    <MudIcon Icon="@GetFileIcon(file.Name)" Class="mr-2" Color="Color.Primary" />
                                                    <div>
                                                        <MudText Typo="Typo.body2" Class="file-name">@file.Name</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            Size: @(file.Size / 1024)KB
                                                        </MudText>
                                                    </div>
                                                </div>
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                             Color="Color.Error" 
                                                             Size="Size.Small"
                                                             OnClick="@(() => RemoveFile(file))" />
                                            </div>
                                        </MudPaper>
                                    }
                                </div>
                            }
                        </div>

                        <div class="stats-section">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Recipients: @TotalSubscribers subscribers
                            </MudText>
                        </div>
                    </div>
                </MudForm>
            </div>

            <div class="email-preview-panel">
                <MudText Typo="Typo.subtitle1" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Preview" Class="mr-2" />
                    Live Email Preview
                </MudText>
                
                <div class="email-preview">
                    <div class="preview-header">
                        <MudText Typo="Typo.subtitle2" Class="preview-subject">
                            Subject: @(!string.IsNullOrWhiteSpace(Subject) ? Subject : "[No Subject]")
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="preview-from-to">
                            From: √çtala Veloso &lt;noreply@italavelosomentor.com&gt;<br/>
                            To: [Subscriber Name] &lt;subscriber@example.com&gt;
                        </MudText>
                    </div>

                    <div class="preview-content">
                        <div class="preview-greeting">
                            <strong>Dear [Subscriber Name],</strong>
                        </div>
                        
                        <div class="preview-content-area">
                            @if (!string.IsNullOrWhiteSpace(EmailContent))
                            {
                                @((MarkupString)EmailContent.Replace("\n", "<br/>"))
                            }
                            else
                            {
                                <em class="preview-empty-content">Email content will appear here as you type...</em>
                            }
                        </div>

                        @if (SelectedFiles.Any())
                        {
                            <div class="preview-attachment">
                                <MudIcon Icon="@Icons.Material.Filled.AttachFile" Class="attachment-icon" />
                                <span class="attachment-label">üìé Attachments (@SelectedFiles.Count):</span>
                                @foreach (var file in SelectedFiles)
                                {
                                    <div class="attachment-file-item">
                                        ‚Ä¢ @file.Name (Size: @(file.Size / 1024)KB)
                                    </div>
                                }
                            </div>
                        }

                        <div class="email-signature">
                            <div class="signature-content">
                                <div>Speak Soon.</div>
                                <div class="signature-contact">
                                    <strong>Blessings √çtala Veloso</strong><br/>
                                    CEO & Founder, JOSTIC<br/>
                                    + 44 (0)7732296421
                                </div>
                                
                                <div class="signature-links">
                                    <a href="https://italaveloso.com/" class="signature-link">Website</a>
                                    <a href="https://www.linkedin.com/in/italaveloso/" class="signature-link">LinkedIn</a>
                                    <a href="https://www.instagram.com/italaveloso.coaching/" class="signature-link">Instagram</a>
                                    <a href="https://www.tiktok.com/@@italaveloso.coaching" class="signature-link">TikTok</a>
                                </div>
                            </div>
                            
                            <hr class="signature-separator" />
                            <div class="unsubscribe-text">
                                You are receiving this email because you subscribed to updates. 
                                If you wish to unsubscribe, click <a href="#" class="unsubscribe-link">unsubscribe</a>.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Stats -->
                <div class="preview-stats mt-3">
                    <MudText Typo="Typo.body2" Class="stats-title">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                        Email Details:
                    </MudText>
                    <MudText Typo="Typo.caption" Class="stats-item">
                        ‚Ä¢ Recipients: @TotalSubscribers subscriber@(TotalSubscribers != 1 ? "s" : "")
                    </MudText>
                    <MudText Typo="Typo.caption" Class="stats-item">
                        ‚Ä¢ Content length: @EmailContent.Length characters
                    </MudText>
                    <MudText Typo="Typo.caption" Class="stats-item">
                        ‚Ä¢ Attachment: @(SelectedFiles.Any() ? $"Yes ({SelectedFiles.Count} file{(SelectedFiles.Count != 1 ? "s" : "")})" : "None")
                    </MudText>
                </div>
            </div>
        </div>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Error" 
                   OnClick="SendEmail" 
                   Disabled="@(!IsFormValid || IsSending || TotalSubscribers == 0)"
                   Variant="Variant.Filled">
            @if (IsSending)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-3">Sending...</MudText>
            }
            else
            {
                <MudText>Send Email (@(IsFormValid ? "Ready" : "Complete form"))</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
#nullable enable
    [CascadingParameter] IDialogReference MudDialog { get; set; } = default!;
    [Parameter] public List<string> RecipientEmails { get; set; } = new();
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public int TotalSubscribers { get; set; }

    private MudForm? EmailForm;
    private string Subject = "";
    private string EmailContent = "";
    private List<IBrowserFile> SelectedFiles = new();
    private bool IsSending = false;
    private bool IsFormValid => !string.IsNullOrWhiteSpace(Subject?.Trim())
                                  && !string.IsNullOrWhiteSpace(EmailContent?.Trim())
                                  && TotalSubscribers > 0;
    private List<string> ValidationErrors = new();

    protected override void OnParametersSet()
    {
        ValidateForm();
        TotalSubscribers = RecipientEmails?.Count ?? 0;
    }

    private void OnFilesChanged(IReadOnlyList<IBrowserFile> files)
    {
        // Add new files to existing list, but respect the 3 file limit
        foreach (var file in files)
        {
            if (SelectedFiles.Count >= 3)
                break;
                
            // Check if file is already in the list (by name and size to avoid duplicates)
            if (!SelectedFiles.Any(f => f.Name == file.Name && f.Size == file.Size))
            {
                SelectedFiles.Add(file);
            }
        }
        StateHasChanged();
    }

    private void RemoveFile(IBrowserFile file)
    {
        SelectedFiles.Remove(file);
        StateHasChanged();
    }

    private string GetContentTypeFromExtension(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "application/pdf",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".txt" => "text/plain",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            _ => "application/octet-stream"
        };
    }

    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".doc" or ".docx" => Icons.Material.Filled.Description,
            ".txt" => Icons.Material.Filled.TextSnippet,
            ".jpg" or ".jpeg" or ".png" => Icons.Material.Filled.Image,
            _ => Icons.Material.Filled.AttachFile
        };
    }

    private void ValidateForm()
    {
        var subjectValid = !string.IsNullOrWhiteSpace(Subject?.Trim());
        var contentValid = !string.IsNullOrWhiteSpace(EmailContent?.Trim());
        var computed = subjectValid && contentValid && TotalSubscribers > 0;

        Console.WriteLine($"Validation: Subject='{Subject}' ({subjectValid}), Content='{EmailContent?.Substring(0, Math.Min(20, EmailContent?.Length ?? 0))}...' ({contentValid}), Recipients={TotalSubscribers}, IsFormValid={computed}");

        StateHasChanged();
    }

    private void ApplyTemplate(string template)
    {
        switch (template.ToLower())
        {
            case "welcome":
                Subject = "Welcome to Your Personal Growth Journey! üåü";
                EmailContent = "I'm so excited to have you join our community of growth-minded individuals!\n\nAs your coach, I'm here to support you every step of the way. You'll receive:\n\n‚ú® Weekly insights and motivation\n‚ú® Practical tools for personal development\n‚ú® Exclusive content just for subscribers\n‚ú® Updates on upcoming workshops and sessions\n\nYour transformation starts now, and I'm honored to be part of your journey.\n\nRemember: You have everything within you to create the life you desire.\n\nWith love and light,";
                break;
            case "newsletter":
                Subject = "Your Monthly Dose of Inspiration üí´";
                EmailContent = "Hello beautiful soul!\n\nHere's what's happening in our community this month:\n\nüå± NEW: [Workshop/Session Title]\nüìö FEATURED: [Article or Resource]\nüí° TIP OF THE MONTH: [Quick actionable tip]\nüéØ UPCOMING: [Event or announcement]\n\n\"The only way to make sense out of change is to plunge into it, move with it, and join the dance.\" - Alan Watts\n\nWhat small step will you take today toward your dreams?\n\nSending you positive energy,";
                break;
            case "announcement":
                Subject = "Important Update for Our Community üì¢";
                EmailContent = "Dear friend,\n\nI wanted to personally share some exciting news with you:\n\n[YOUR ANNOUNCEMENT HERE]\n\nThis is just another step in our journey together, and I'm grateful to have you as part of this amazing community.\n\nIf you have any questions, please don't hesitate to reach out. I'm always here to support you.\n\nWith gratitude,";
                break;
            case "coaching":
                Subject = "Your Weekly Coaching Insight üß†‚ú®";
                EmailContent = "Hello there, wonderful human!\n\nThis week, I want to share something powerful with you:\n\nüí≠ MINDSET SHIFT: [Key insight or reframe]\n\nüéØ ACTION STEP: Try this simple exercise:\n[Specific action or practice]\n\nüìù REFLECTION QUESTION:\n\"[Thought-provoking question to consider]\"\n\nRemember: Progress isn't always linear. Every small step counts, and you're doing better than you think.\n\nBelieve in yourself as much as I believe in you!\n\nWith encouragement,";
                break;
            case "event":
                Subject = "You're Invited! Special Event Just for You üéâ";
                EmailContent = "I have something special to invite you to!\n\nüóìÔ∏è EVENT: [Workshop/Session Name]\nüìÖ DATE: [Date and Time]\nüìç LOCATION: [Location or \"Online\"]\nüí∞ INVESTMENT: [Price or \"Free\"]\n\nTHIS EVENT IS PERFECT FOR YOU IF:\n‚Ä¢ [Benefit 1]\n‚Ä¢ [Benefit 2]\n‚Ä¢ [Benefit 3]\n\nYOU'LL WALK AWAY WITH:\n‚úì [Outcome 1]\n‚úì [Outcome 2]\n‚úì [Outcome 3]\n\nSpaces are limited, so secure your spot today!\n\n[REGISTER HERE: Link]\n\nI can't wait to see you there and support your growth!\n\nWith excitement,";
                break;
            case "gratitude":
                Subject = "A heartfelt thank you from me to you üíï";
                EmailContent = "My dear friend,\n\nI had to pause today and express my deep gratitude for YOU.\n\nThank you for:\nüôè Being part of this beautiful community\nüôè Trusting me with your growth journey\nüôè Showing up for yourself, even when it's hard\nüôè Inspiring me with your courage and commitment\n\nYour presence makes this community more vibrant, and your growth ripples out to touch so many lives.\n\nNever forget how powerful you are and how much you matter.\n\nThe world is better because you're in it.\n\nWith infinite love and appreciation,";
                break;
        }
        ValidateForm();
        StateHasChanged();
    }

    private async Task SendEmail()
    {
        if (!IsFormValid || IsSending || TotalSubscribers == 0)
            return;

        await ConfirmSendEmail();
    }

    private async Task ConfirmSendEmail()
    {
        if (IsSending) return;

        IsSending = true;

        List<(string, Stream, string)>? attachments = null;

        try
        {
            var hasFiles = SelectedFiles.Any();
            attachments = hasFiles ? new List<(string, Stream, string)>() : null;

            if (hasFiles)
            {
                foreach (var file in SelectedFiles)
                {
                    var stream = new MemoryStream();
                    await file.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(stream);
                    stream.Position = 0;

                    // Determine proper content type based on file extension
                    var contentType = file.ContentType ?? GetContentTypeFromExtension(file.Name);
                    attachments!.Add((file.Name, (Stream)stream, contentType));
                }
            }

            var success = await EmailSubscriptionService.SendCustomEmailAsync(RecipientEmails, Subject, EmailContent, attachments);

            if (success)
            {
                Snackbar?.Add($"Email sent successfully to {TotalSubscribers} subscriber{(TotalSubscribers != 1 ? "s" : "")}!", Severity.Success);
            }
            else
            {
                Snackbar?.Add("Failed to send email. Please check the logs for details.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar?.Add($"Failed to send email: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsSending = false;

            try
            {
                Subject = "";
                EmailContent = "";
                SelectedFiles.Clear();
                ValidationErrors.Clear();

                MudDialog?.Close(DialogResult.Ok(true));
            }
            catch (Exception closeEx)
            {
                Console.WriteLine($"Warning: dialog close/cleanup failed after send: {closeEx}");
                Snackbar?.Add($"Email sent but UI cleanup failed: {closeEx.Message}", Severity.Warning);
            }
        }
    }

    private void Cancel()
    {
        MudDialog?.Close(DialogResult.Cancel());
    }

    private void Close()
    {
        Subject = "";
        EmailContent = "";
        SelectedFiles.Clear();
        IsSending = false;
        ValidationErrors.Clear();

        MudDialog?.Close(DialogResult.Ok(true));
    }
}